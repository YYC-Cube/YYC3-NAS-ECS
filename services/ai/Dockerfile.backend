# ğŸ“¦ Dockerfile.backend - ç”Ÿäº§çº§åç«¯Dockerfile
# ==========================================
# é˜¶æ®µ 1: ä¾èµ–å®‰è£… (åˆ©ç”¨ç¼“å­˜)
# ==========================================
FROM oven/bun:1 AS base
WORKDIR /app

# å®‰è£…ä¾èµ–
FROM base AS deps
COPY package.json bun.lockb ./
RUN bun install --frozen-lockfile --production

# ==========================================
# é˜¶æ®µ 2: æ„å»ºé˜¶æ®µ (ç¼–è¯‘TypeScript)
# ==========================================
FROM base AS builder
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# è®¾ç½®ç¯å¢ƒä¸ºç”Ÿäº§ï¼Œä½†ä¸æ„å»ºç”Ÿäº§åŒ…ï¼ˆå› ä¸ºè¿™æ˜¯åç«¯ï¼‰
ENV NODE_ENV=production

# æ„å»ºTypeScript (å¦‚æœéœ€è¦tscï¼Œæˆ–è€…ç›´æ¥è¿è¡Œ)
# è¿™é‡Œå‡è®¾Bunå¯ä»¥ç›´æ¥è¿è¡ŒTSï¼Œæˆ–è€…å·²ç»æ„å»ºå¥½äº†JS
# å¦‚æœæœ‰buildå‘½ä»¤ï¼š
# RUN bun run build

# ==========================================
# é˜¶æ®µ 3: ç”Ÿäº§è¿è¡Œé•œåƒ (æç®€é•œåƒ)
# ==========================================
FROM oven/bun:1-alpine AS runner
WORKDIR /app

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup --system --gid 1001 bun && \
    adduser --system --uid 1001 bun

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV PORT=3000

# å¤åˆ¶ä¾èµ–å’Œä»£ç 
COPY --from=deps /app/node_modules ./node_modules
COPY --from=builder /app/src ./src
COPY --from=builder /app/package.json ./

# åˆ‡æ¢ç”¨æˆ·
USER bun

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD bun --version || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["bun", "run", "src/index.ts"]
